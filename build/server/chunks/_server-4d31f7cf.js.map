{"version":3,"file":"_server-4d31f7cf.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/incident/_server.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { a as auth, P as ParseIncidentPayload, G as GHIssueToKenerIncident } from \"../../../../chunks/webhook.js\";\nimport { C as CreateIssue, S as SearchIssue } from \"../../../../chunks/github.js\";\nimport { p as public_env } from \"../../../../chunks/shared-server.js\";\nimport fs from \"fs-extra\";\nasync function POST({ request }) {\n  const payload = await request.json();\n  const authError = auth(request);\n  if (authError !== null) {\n    return json(\n      { error: authError.message },\n      {\n        status: 401\n      }\n    );\n  }\n  let { title, body, githubLabels, error } = ParseIncidentPayload(payload);\n  if (error) {\n    return json(\n      { error },\n      {\n        status: 400\n      }\n    );\n  }\n  let site = JSON.parse(fs.readFileSync(public_env.PUBLIC_KENER_FOLDER + \"/site.json\", \"utf8\"));\n  let github = site.github;\n  let resp = await CreateIssue(github, title, body, githubLabels);\n  if (resp === null) {\n    return json(\n      { error: \"github error\" },\n      {\n        status: 400\n      }\n    );\n  }\n  return json(GHIssueToKenerIncident(resp), {\n    status: 200\n  });\n}\nasync function GET({ request, url }) {\n  const authError = auth(request);\n  if (authError !== null) {\n    return json(\n      { error: authError.message },\n      {\n        status: 401\n      }\n    );\n  }\n  const query = url.searchParams;\n  const state = query.get(\"state\") || \"open\";\n  const tags = query.get(\"tags\") || \"\";\n  const page = query.get(\"page\") || 1;\n  const per_page = query.get(\"per_page\") || 10;\n  const createdAfter = query.get(\"created_after_utc\") || \"\";\n  const createdBefore = query.get(\"created_before_utc\") || \"\";\n  const titleLike = query.get(\"title_like\") || \"\";\n  if (state !== \"open\" && state !== \"closed\") {\n    return json(\n      { error: \"state must be open or closed\" },\n      {\n        status: 400\n      }\n    );\n  }\n  let site = JSON.parse(\n    fs.readFileSync(public_env.PUBLIC_KENER_FOLDER + \"/site.json\", \"utf8\")\n  );\n  let github = site.github;\n  const repo = `${github.owner}/${github.repo}`;\n  const is = \"issue\";\n  const filterArray = [\n    `repo:${repo}`,\n    `is:${is}`,\n    `state:${state}`,\n    `label:incident`,\n    `sort:created-desc`,\n    `label:${tags.split(\",\").map((tag) => tag.trim()).join(\",\")}`\n  ];\n  if (createdBefore && createdAfter) {\n    let dateFilter = \"\";\n    let iso = new Date(createdAfter * 1e3).toISOString();\n    dateFilter += `created:${iso}`;\n    iso = new Date(createdBefore * 1e3).toISOString();\n    dateFilter += `..${iso}`;\n    filterArray.push(dateFilter);\n  } else if (createdAfter) {\n    let iso = new Date(createdAfter * 1e3).toISOString();\n    filterArray.push(`created:>=${iso}`);\n  } else if (createdBefore) {\n    let iso = new Date(createdBefore * 1e3).toISOString();\n    filterArray.push(`created:<=${iso}`);\n  }\n  if (titleLike) {\n    filterArray.unshift(`${titleLike} in:title`);\n  }\n  const resp = await SearchIssue(filterArray, page, per_page);\n  const incidents = resp.items.map((issue) => GHIssueToKenerIncident(issue));\n  return json(\n    incidents,\n    {\n      status: 200\n    }\n  );\n}\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}