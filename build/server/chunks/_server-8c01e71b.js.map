{"version":3,"file":"_server-8c01e71b.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/incident/_incidentNumber_/status/_server.js"],"sourcesContent":["import { j as json } from \"../../../../../../chunks/index.js\";\nimport { a as auth, G as GHIssueToKenerIncident } from \"../../../../../../chunks/webhook.js\";\nimport { G as GetIncidentByNumber, b as UpdateIssueLabels } from \"../../../../../../chunks/github.js\";\nimport { p as public_env } from \"../../../../../../chunks/shared-server.js\";\nimport fs from \"fs-extra\";\nasync function POST({ request, params }) {\n  const payload = await request.json();\n  const incidentNumber = params.incidentNumber;\n  const authError = auth(request);\n  if (authError !== null) {\n    return json(\n      { error: authError.message },\n      {\n        status: 401\n      }\n    );\n  }\n  let isIdentified = payload.isIdentified;\n  let isResolved = payload.isResolved;\n  let endDatetime = payload.endDatetime;\n  if (!incidentNumber || isNaN(incidentNumber)) {\n    return json(\n      { error: \"Invalid incidentNumber\" },\n      {\n        status: 400\n      }\n    );\n  }\n  if (endDatetime && typeof endDatetime !== \"number\") {\n    return json(\n      { error: \"Invalid endDatetime\" },\n      {\n        status: 400\n      }\n    );\n  }\n  let site = JSON.parse(fs.readFileSync(public_env.PUBLIC_KENER_FOLDER + \"/site.json\", \"utf8\"));\n  let github = site.github;\n  let issue = await GetIncidentByNumber(github, incidentNumber);\n  if (issue === null) {\n    return json(\n      { error: \"github error\" },\n      {\n        status: 400\n      }\n    );\n  }\n  let labels = issue.labels.map((label) => {\n    return label.name;\n  });\n  if (isIdentified !== void 0) {\n    labels = labels.filter((label) => label !== \"identified\");\n    if (isIdentified === true) {\n      labels.push(\"identified\");\n    }\n  }\n  if (isResolved !== void 0) {\n    labels = labels.filter((label) => label !== \"resolved\");\n    if (isResolved === true) {\n      labels.push(\"resolved\");\n    }\n  }\n  let body = issue.body;\n  if (endDatetime) {\n    body = body.replace(/\\[end_datetime:(\\d+)\\]/g, \"\");\n    body = body.trim();\n    body = body + ` [end_datetime:${endDatetime}]`;\n  }\n  let resp = await UpdateIssueLabels(github, incidentNumber, labels, body);\n  if (resp === null) {\n    return json(\n      { error: \"github error\" },\n      {\n        status: 400\n      }\n    );\n  }\n  return json(GHIssueToKenerIncident(resp), {\n    status: 200\n  });\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}